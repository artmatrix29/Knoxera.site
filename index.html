<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Knoxera</title>
  <link rel="icon" type="image/png" href="knoxeralogo.png" />
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: black;
      overflow: hidden;
      user-select: none;
      font-family: Arial, sans-serif;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #header {
      display: flex;
      align-items: center;
      margin: 10px;
      gap: 10px;
      user-select: none;
      color: #4cc9f0;
      font-weight: bold;
      font-size: 1.5rem;
    }
    #header img {
      height: 40px;
      width: 40px;
      border-radius: 50%;
    }
    canvas {
      background: black;
      display: block;
      border: 1px solid white;
      flex-grow: 1;
      width: 100vw;
      height: calc(100vh - 90px);
      margin-bottom: 20px;
    }
    #counter {
      position: fixed;
      top: 10px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: bold;
      user-select: none;
      color: #4cc9f0;
      text-shadow: 0 0 5px black;
      z-index: 10;
      font-size: 20px;
    }
    #counter img {
      width: 32px;
      height: 32px;
      image-rendering: pixelated;
    }

    /* Меню */
    #menu {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 20;
      user-select: none;
      overflow: hidden;
      color: white;
    }
    #menu h2 {
      margin-bottom: 30px;
      font-weight: normal;
      font-size: 2rem;
      color: white;
      text-shadow: 0 0 10px #666;
    }
    #form-container {
      background: #111;
      padding: 25px 40px;
      border-radius: 10px;
      box-shadow: 0 0 15px #222;
      display: flex;
      flex-direction: column;
      gap: 15px;
      width: 320px;
      color: #eee;
      font-weight: normal;
    }
    #form-container label {
      font-size: 0.9rem;
      margin-bottom: 3px;
    }
    #form-container input[type="text"],
    #form-container input[type="email"],
    #form-container input[type="password"] {
      padding: 8px 10px;
      font-size: 1rem;
      border: 1px solid #555;
      border-radius: 4px;
      background: #222;
      color: #eee;
      outline: none;
      transition: border-color 0.2s ease;
    }
    #form-container input[type="text"]:focus,
    #form-container input[type="email"]:focus,
    #form-container input[type="password"]:focus {
      border-color: #bbb;
      background: #333;
    }
    #form-container button {
      background: black;
      border: 2px solid white;
      color: white;
      font-weight: bold;
      padding: 10px;
      font-size: 1.1rem;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease, color 0.3s ease;
    }
    #form-container button:hover:not(:disabled) {
      background: white;
      color: black;
    }
    #form-container button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    #google-login {
      margin-top: 15px;
      background: white;
      color: black;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      border-radius: 5px;
      padding: 10px;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s ease;
    }
    #google-login:hover {
      background: #ddd;
    }
    #google-login img {
      height: 20px;
      width: 20px;
    }

    /* Плавающие шарики */
    #particles {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 15;
      background: transparent;
    }
  </style>
</head>
<body>

  <div id="menu">
    <canvas id="particles"></canvas>
    <h2>Регистрация аккаунта</h2>
    <div id="form-container">
      <label for="email">Email</label>
      <input type="email" id="email" placeholder="Введите email" required />

      <label for="password">Пароль</label>
      <input type="password" id="password" placeholder="Введите пароль" required />

      <label for="nickname">Никнейм</label>
      <input type="text" id="nickname" placeholder="Ваш ник" maxlength="20" required />

      <button id="registerBtn" disabled>Зарегистрироваться</button>

      <div id="google-login">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/53/Google_%22G%22_Logo.svg/512px-Google_%22G%22_Logo.svg.png" alt="Google logo" />
        Войти через Google
      </div>
    </div>
  </div>

  <div id="header" style="display:none;">
    <img src="knoxeralogo.png" alt="Knoxera Logo" />
    <h1>Knoxera</h1>
  </div>

  <canvas id="game" style="display:none;"></canvas>
  
  <div id="counter" style="display:none;">
    <img src="greencristal.png" alt="crystal" />
    <span id="crystal-count">0</span>
  </div>

<script>
  // --- Валидация формы регистрации ---
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const nicknameInput = document.getElementById('nickname');
  const registerBtn = document.getElementById('registerBtn');

  function validateForm() {
    const emailValid = emailInput.value.trim().length > 0 && emailInput.checkValidity();
    const passwordValid = passwordInput.value.trim().length >= 6;
    const nickValid = nicknameInput.value.trim().length >= 2;
    registerBtn.disabled = !(emailValid && passwordValid && nickValid);
  }

  emailInput.addEventListener('input', validateForm);
  passwordInput.addEventListener('input', validateForm);
  nicknameInput.addEventListener('input', validateForm);

  // --- Псевдо-регистрация и старт игры ---
  registerBtn.addEventListener('click', () => {
    // Здесь должна быть настоящая регистрация и авторизация
    const nickname = nicknameInput.value.trim();
    if (!nickname) return;

    document.getElementById('menu').style.display = 'none';
    document.getElementById('header').style.display = 'flex';
    document.getElementById('game').style.display = 'block';
    document.getElementById('counter').style.display = 'flex';

    // В шапке отображаем только логотип и название (ник не показываем)

    startGame();
  });

  // --- Имитируем нажатие на Google Login ---
  document.getElementById('google-login').addEventListener('click', () => {
    alert('Тут должна быть интеграция с Google OAuth. Пока это заглушка.');
  });

  // === Плавающие шарики на фоне меню ===
  const particlesCanvas = document.getElementById('particles');
  const pCtx = particlesCanvas.getContext('2d');

  let pWidth, pHeight;
  function resizeParticles() {
    pWidth = window.innerWidth;
    pHeight = window.innerHeight;
    particlesCanvas.width = pWidth;
    particlesCanvas.height = pHeight;
  }
  resizeParticles();
  window.addEventListener('resize', resizeParticles);

  const particleCount = 50;
  const particles = [];
  for (let i = 0; i < particleCount; i++) {
    particles.push({
      x: Math.random() * pWidth,
      y: Math.random() * pHeight,
      radius: Math.random() * 3 + 1,
      speedY: Math.random() * 0.6 + 0.2,
      speedX: (Math.random() - 0.5) * 0.3,
      alpha: Math.random() * 0.6 + 0.4,
    });
  }

  function drawParticles() {
    pCtx.clearRect(0, 0, pWidth, pHeight);
    for (const p of particles) {
      p.y -= p.speedY;
      p.x += p.speedX;

      if (p.y < 0) p.y = pHeight;
      if (p.x < 0) p.x = pWidth;
      if (p.x > pWidth) p.x = 0;

      pCtx.beginPath();
      pCtx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
      pCtx.fillStyle = `rgba(255,255,255,${p.alpha.toFixed(2)})`;
      pCtx.fill();
    }
    requestAnimationFrame(drawParticles);
  }
  drawParticles();


  // === Игра ===
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');

  const tileSize = 40;
  const chunkSize = 16;

  const chunks = new Map();
  const crystals = new Map();

  const player = {
    x: 0,
    y: 0,
    radius: tileSize / 3,
    speed: 3,
    color: '#4cc9f0'  // Голубой цвет игрока
  };

  let crystalsCollected = 0;
  const keys = { w: false, a: false, s: false, d: false };

  function generateChunk(cx, cy) {
    let chunk = [];
    for (let y = 0; y < chunkSize; y++) {
      let row = [];
      for (let x = 0; x < chunkSize; x++) {
        if (x > 0 && y > 0 && x < chunkSize - 1 && y < chunkSize - 1) {
          row.push(Math.random() < 0.1 ? 1 : 0);
        } else {
          row.push(Math.random() < 0.5 ? 1 : 0);
        }
      }
      chunk.push(row);
    }

    if (Math.random() < 0.6) {
      const exitLeftY = Math.floor(Math.random() * (chunkSize - 2)) + 1;
      chunk[exitLeftY][0] = 0;
    }
    if (Math.random() < 0.6) {
      const exitRightY = Math.floor(Math.random() * (chunkSize - 2)) + 1;
      chunk[exitRightY][chunkSize - 1] = 0;
    }
    if (Math.random() < 0.6) {
      const exitTopX = Math.floor(Math.random() * (chunkSize - 2)) + 1;
      chunk[0][exitTopX] = 0;
    }
    if (Math.random() < 0.6) {
      const exitBottomX = Math.floor(Math.random() * (chunkSize - 2)) + 1;
      chunk[chunkSize - 1][exitBottomX] = 0;
    }

    if (Math.random() < 0.15) {
      let freeCells = [];
      for (let y = 1; y < chunkSize - 1; y++) {
        for (let x = 1; x < chunkSize - 1; x++) {
          if (chunk[y][x] === 0) {
           
