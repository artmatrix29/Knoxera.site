<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Knoxera</title>
  <link rel="icon" type="image/png" href="knoxeralogo.png" />
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: black;
      overflow: hidden;
      user-select: none;
      font-family: Arial, sans-serif;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #header {
      display: flex;
      align-items: center;
      margin: 10px;
      gap: 10px;
      user-select: none;
      color: #4cc9f0;
      font-weight: bold;
      font-size: 1.5rem;
    }
    #header img {
      height: 40px;
      width: 40px;
      border-radius: 50%;
    }
    canvas {
      background: black;
      display: block;
      border: 1px solid white;
      flex-grow: 1;
      width: 100vw;
      height: calc(100vh - 90px);
      margin-bottom: 20px;
    }
    #counter {
      position: fixed;
      top: 10px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: bold;
      user-select: none;
      color: #4cc9f0;
      text-shadow: 0 0 5px black;
      z-index: 10;
      font-size: 20px;
    }
    #counter img {
      width: 32px;
      height: 32px;
      image-rendering: pixelated;
    }

    /* Меню */
    #menu {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 20;
      user-select: none;
      overflow: hidden;
      color: white;
    }
    #menu h2 {
      margin-bottom: 30px;
      font-weight: normal;
      font-size: 2rem;
      color: white;
      text-shadow: 0 0 10px #666;
    }
    #form-container {
      background: #111;
      padding: 25px 40px;
      border-radius: 10px;
      box-shadow: 0 0 15px #222;
      display: flex;
      flex-direction: column;
      gap: 15px;
      width: 320px;
      color: #eee;
      font-weight: normal;
    }
    #form-container label {
      font-size: 0.9rem;
      margin-bottom: 3px;
    }
    #form-container input[type="text"],
    #form-container input[type="email"],
    #form-container input[type="password"] {
      padding: 8px 10px;
      font-size: 1rem;
      border: 1px solid #555;
      border-radius: 4px;
      background: #222;
      color: #eee;
      outline: none;
      transition: border-color 0.2s ease;
    }
    #form-container input[type="text"]:focus,
    #form-container input[type="email"]:focus,
    #form-container input[type="password"]:focus {
      border-color: #bbb;
      background: #333;
    }
    #form-container button {
      background: black;
      border: 2px solid white;
      color: white;
      font-weight: bold;
      padding: 10px;
      font-size: 1.1rem;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease, color 0.3s ease;
    }
    #form-container button:hover:not(:disabled) {
      background: white;
      color: black;
    }
    #form-container button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    #google-login {
      margin-top: 15px;
      background: white;
      color: black;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      border-radius: 5px;
      padding: 10px;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s ease;
    }
    #google-login:hover {
      background: #ddd;
    }
    #google-login img {
      height: 20px;
      width: 20px;
    }

    /* Плавающие шарики */
    #particles {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 15;
      background: transparent;
    }
  </style>
</head>
<body>

  <div id="menu">
    <canvas id="particles"></canvas>
    <h2>Регистрация / Вход в аккаунт</h2>
    <div id="form-container">
      <label for="email">Email</label>
      <input type="email" id="email" placeholder="Введите email" required />

      <label for="password">Пароль</label>
      <input type="password" id="password" placeholder="Введите пароль" required />

      <label for="nickname">Никнейм (только при регистрации)</label>
      <input type="text" id="nickname" placeholder="Ваш ник" maxlength="20" />

      <button id="registerBtn" disabled>Зарегистрироваться</button>
      <button id="loginBtn" disabled>Войти</button>

      <div id="google-login">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/53/Google_%22G%22_Logo.svg/512px-Google_%22G%22_Logo.svg.png" alt="Google logo" />
        Войти через Google
      </div>
    </div>
  </div>

  <div id="header" style="display:none;">
    <img src="knoxeralogo.png" alt="Knoxera Logo" />
    <h1>Knoxera</h1>
  </div>

  <canvas id="game" style="display:none;"></canvas>

  <div id="counter" style="display:none;">
    <img src="greencristal.png" alt="crystal" />
    <span id="crystal-count">0</span>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  // --- FIREBASE INIT ---
  const firebaseConfig = {
    apiKey: "AIzaSyD6kjiQCEjtI537KqmEN34NxOZ6BBIbC2c",
    authDomain: "knoxera.firebaseapp.com",
    projectId: "knoxera",
    storageBucket: "knoxera.firebasestorage.app",
    messagingSenderId: "207649077497",
    appId: "1:207649077497:web:01e865716c790acf798a28",
    measurementId: "G-913NRJWC1Z"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // --- Валидация формы ---
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const nicknameInput = document.getElementById('nickname');
  const registerBtn = document.getElementById('registerBtn');
  const loginBtn = document.getElementById('loginBtn');

  function validateForm() {
    const emailValid = emailInput.value.trim().length > 0 && emailInput.checkValidity();
    const passwordValid = passwordInput.value.trim().length >= 6;
    const nickValid = nicknameInput.value.trim().length >= 2;
    registerBtn.disabled = !(emailValid && passwordValid && nickValid);
    loginBtn.disabled = !(emailValid && passwordValid);
  }

  emailInput.addEventListener('input', validateForm);
  passwordInput.addEventListener('input', validateForm);
  nicknameInput.addEventListener('input', validateForm);

  // --- Переменные игры и прогресса ---
  let currentUser = null;
  let crystalsCollected = 0;

  // --- Кнопка регистрации ---
  registerBtn.addEventListener('click', async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    const nickname = nicknameInput.value.trim();
    if (!email || !password || !nickname) return;

    try {
      const userCredential = await auth.createUserWithEmailAndPassword(email, password);
      currentUser = userCredential.user;

      // Сохраняем никнейм и кристаллы в базе
      await db.collection('users').doc(currentUser.uid).set({
        nickname: nickname,
        crystals: 0
      });

      onLoginSuccess(nickname, 0);

    } catch (error) {
      alert('Ошибка регистрации: ' + error.message);
    }
  });

  // --- Кнопка входа ---
  loginBtn.addEventListener('click', async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if (!email || !password) return;

    try {
      const userCredential = await auth.signInWithEmailAndPassword(email, password);
      currentUser = userCredential.user;

      // Получаем данные из базы
      const doc = await db.collection('users').doc(currentUser.uid).get();
      if (doc.exists) {
        const data = doc.data();
        onLoginSuccess(data.nickname || 'Игрок', data.crystals || 0);
      } else {
        // Если данных нет (редко), создаем дефолт
        await db.collection('users').doc(currentUser.uid).set({
          nickname: 'Игрок',
          crystals: 0
        });
        onLoginSuccess('Игрок', 0);
      }

    } catch (error) {
      alert('Ошибка входа: ' + error.message);
    }
  });

  // --- Вход через Google ---
  document.getElementById('google-login').addEventListener('click', async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      const result = await auth.signInWithPopup(provider);
      currentUser = result.user;

      // Проверяем есть ли пользователь в базе
      const doc = await db.collection('users').doc(currentUser.uid).get();
      if (!doc.exists) {
        // Сохраняем ник из Google displayName
        await db.collection('users').doc(currentUser.uid).set({
          nickname: currentUser.displayName || 'Игрок',
          crystals: 0
        });
      }

      const data = doc.exists ? doc.data() : { crystals: 0 };
      onLoginSuccess(currentUser.displayName || 'Игрок', data.crystals || 0);

    } catch (error) {
      alert('Ошибка входа через Google: ' + error.message);
    }
  });

  // --- Обработка успешного входа ---
  function onLoginSuccess(nickname, crystals) {
    crystalsCollected = crystals;
    document.getElementById('crystal-count').textContent = crystalsCollected;
    document.getElementById('menu').style.display = 'none';
    document.getElementById('header').style.display = 'flex';
    document.getElementById('game').style.display = 'block';
    document.getElementById('counter').style.display = 'flex';

    document.querySelector('#header h1').textContent = `Knoxera — ${nickname}`;

    startGame();
  }

  // --- Слушатель авторизации (сохраняем сессию) ---
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentUser = user;
      const doc = await db.collection('users').doc(user.uid).get();
      if (doc.exists) {
        const data = doc.data();
        onLoginSuccess(data.nickname || 'Игрок', data.crystals || 0);
      } else {
        onLoginSuccess('Игрок', 0);
      }
    } else {
      currentUser = null;
      // Показываем меню входа
      document.getElementById('menu').style.display = 'flex';
      document.getElementById('header').style.display = 'none';
      document.getElementById('game').style.display = 'none';
      document.getElementById('counter').style.display = 'none';
    }
  });


  // ------------------- Игровая часть -------------------

  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');

  // Параметры игры
  const tileSize = 32;
  const chunkSize = 20; // как в твоём коде
  const chunkCount = 6;

  // Игрок
  let player = {
    x: 0,
    y: 0,
    speed: 4,
    radius: 12,
    color: '#4cc9f0'
  };

  // Кристаллы (храним в Map, ключ — уникальный id)
  const crystals = new Map();

  // Поддержка клавиш
  const keys = {};

  window.addEventListener('keydown', e => { keys[e.key.toLowerCase()] = true; });
  window.addEventListener('keyup', e => { keys[e.key.toLowerCase()] = false; });

  // Размер канваса под размер окна
  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight - 90;
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  // Запускаем игру
  function startGame() {
    // Установим стартовую позицию игрока посередине карты
    player.x = (chunkSize * chunkCount * tileSize) / 2;
    player.y = (chunkSize * chunkCount * tileSize) / 2;

    // Создаём кристаллы в рандомных местах (например 50 штук)
    generateCrystals(50);

    requestAnimationFrame(gameLoop);
  }

  // Генерация кристаллов
  function generateCrystals(count) {
    crystals.clear();
    for (let i = 0; i < count; i++) {
      // Уникальный ключ
      const id = 'c' + i;

      // Случайная позиция в пределах всей карты
      const cx = Math.floor(Math.random() * chunkCount * chunkSize);
      const cy = Math.floor(Math.random() * chunkCount * chunkSize);

      crystals.set(id, { cx, cy });
    }
  }

  // Обновляем количество кристаллов в базе
  function updateCrystalsInDb() {
    if (!currentUser) return;
    db.collection('users').doc(currentUser.uid).update({
      crystals: crystalsCollected
    }).catch(console.error);
  }

  // Проверяем сбор кристаллов
  function checkCrystalPickup() {
    for (const [key, c] of crystals) {
      const cxPos = c.cx * tileSize + tileSize / 2;
      const cyPos = c.cy * tileSize + tileSize / 2;
      const dist = Math.hypot(player.x - cxPos, player.y - cyPos);
      if (dist < player.radius + 10) {
        crystals.delete(key);
        crystalsCollected++;
        document.getElementById('crystal-count').textContent = crystalsCollected;
        updateCrystalsInDb();
      }
    }
  }

  // Отрисовка игрового мира
  function drawWorld() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Рисуем игрока
    ctx.fillStyle = player.color;
    ctx.beginPath();
    ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
    ctx.fill();

    // Рисуем кристаллы
    ctx.fillStyle = '#2de33b';
    for (const c of crystals.values()) {
      const cx = c.cx * tileSize + tileSize / 2;
      const cy = c.cy * tileSize + tileSize / 2;
      ctx.beginPath();
      ctx.arc(cx, cy, 8, 0, Math.PI * 2);
      ctx.fill();
      // Добавим небольшой блеск
      ctx.strokeStyle = 'rgba(255,255,255,0.5)';
      ctx.lineWidth = 2;
      ctx.stroke();
    }
  }

  // Обновление позиции игрока
  function updatePlayer() {
    if (keys['w'] || keys['arrowup']) player.y -= player.speed;
    if (keys['s'] || keys['arrowdown']) player.y += player.speed;
    if (keys['a'] || keys['arrowleft']) player.x -= player.speed;
    if (keys['d'] || keys['arrowright']) player.x += player.speed;

    // Ограничиваем по границам карты
    const maxPos = chunkCount * chunkSize * tileSize;
    if (player.x < player.radius) player.x = player.radius;
    if (player.y < player.radius) player.y = player.radius;
    if (player.x > maxPos - player.radius) player.x = maxPos - player.radius;
    if (player.y > maxPos - player.radius) player.y = maxPos - player.radius;
  }

  // Главный цикл игры
  function gameLoop() {
    updatePlayer();
    checkCrystalPickup();
    drawWorld();
    requestAnimationFrame(gameLoop);
  }

  // ---------------------------------------------

</script>
</body>
</html>
